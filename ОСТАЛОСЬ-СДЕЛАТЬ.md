# Обновление сайта на Render и импорт базы

## Актуальные исправления (уже в коде)

- **Админка → Сообщения** — мигание списка убрано: опрос раз в 4 с только добавляет новые сообщения (без перерисовки всего списка). При ошибке отправки ответа показывается уведомление.
- **500 в дашборде админки** — для PostgreSQL используются запросы с EXTRACT (месяц/день/год) вместо MONTH/YEAR/DAY.
- **500 в чате поддержки** — безопасная работа с датами сообщений и last_seen.
- **500 после регистрации** — отключена отправка верификации; регистрация с обработкой ошибок и редиректом.

---

## Git push (обновить сайт после изменений в коде)

В папке проекта выполните:

```bash
cd c:\ospanel\domains\DesignCraft
git add .
git commit -m "Описание изменений"
git push origin main
```

(Команды можно скопировать из файла **git-push.txt** в корне проекта.)

При включённом Auto-Deploy Render сам задеплоит изменения через 1–2 минуты.

---

## Импорт базы (на всякий случай)

Маршрут **`/import-db`** оставлен в коде. Если понадобится снова залить данные из дампа:

1. Локально: обновите JSON в `database/db-export` (например `php artisan db:export`, затем скопируйте файлы из `storage/app/db-export` в `database/db-export`).
2. Закоммитьте и запушьте:
   ```bash
   git add database/db-export/
   git commit -m "Update db export"
   git push origin main
   ```
3. В **Environment** на Render добавьте переменную `IMPORT_DB_TOKEN` = любой секрет.
4. После деплоя откройте один раз: `https://designcraft-xej3.onrender.com/import-db?token=ВАШ_ТОКЕН`
5. После импорта удалите `IMPORT_DB_TOKEN` из Environment.
6. Если не входится под админом — добавьте `SETUP_ADMIN_TOKEN`, откройте `/setup-admin?token=...` один раз, затем удалите переменную.

---

## Если не входится под админом (после импорта БД)

Пароль в базе мог перезаписаться из дампа. В **Environment** на Render снова добавьте `SETUP_ADMIN_TOKEN` = любой секрет, откройте в браузере один раз: `https://ваш-сайт.onrender.com/setup-admin?token=ВАШ_ТОКЕН`. После этого войдите под `ii5543135@gmail.com` / `ii5543135@gmail.com` и удалите `SETUP_ADMIN_TOKEN`.

---

## Если 500 после регистрации или в админ-панели

В коде исправлен middleware обновления «последний визит» (UpdateUserLastSeen). Убедитесь, что на Render задеплоена последняя версия (`git push origin main`), затем снова зарегистрируйтесь или откройте админку. Если 500 остаётся — откройте в Render **Logs** и посмотрите текст ошибки в момент действия.
